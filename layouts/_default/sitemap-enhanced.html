{{ define "main" }}
<div class="sitemap-container">
    <h1>Enhanced Site Map</h1>
    <p class="sitemap-description">Complete overview of all pages, posts, and taxonomies on this website.</p>
    
    <div class="sitemap-controls">
        <button id="expand-all" class="sitemap-control-btn">Expand All</button>
        <button id="collapse-all" class="sitemap-control-btn">Collapse All</button>
        <button id="toggle-taxonomies" class="sitemap-control-btn">Toggle Taxonomies</button>
    </div>
    
    <div class="sitemap-tree">
        {{ template "sitemap-enhanced-tree-item" (dict "page" .Site.Home "level" 0 "maxLevel" 4) }}
    </div>
    
    <!-- Taxonomy Section -->
    <div class="sitemap-taxonomy-section">
        <h2>Taxonomies</h2>
        <div class="sitemap-taxonomies">
            {{ if .Site.Taxonomies.tags }}
            <div class="sitemap-taxonomy-group">
                <h3>Tags</h3>
                <div class="sitemap-taxonomy-terms">
                    {{ range $name, $pages := .Site.Taxonomies.tags }}
                    <div class="sitemap-taxonomy-term">
                        <a href="{{ printf "/tags/%s/" $name }}">
                            <span class="sitemap-icon sitemap-taxonomy-icon"></span>
                            {{ $name | title }} ({{ len $pages }})
                        </a>
                    </div>
                    {{ end }}
                </div>
            </div>
            {{ end }}
            
            {{ if .Site.Taxonomies.categories }}
            <div class="sitemap-taxonomy-group">
                <h3>Categories</h3>
                <div class="sitemap-taxonomy-terms">
                    {{ range $name, $pages := .Site.Taxonomies.categories }}
                    <div class="sitemap-taxonomy-term">
                        <a href="{{ printf "/categories/%s/" $name }}">
                            <span class="sitemap-icon sitemap-taxonomy-icon"></span>
                            {{ $name | title }} ({{ len $pages }})
                        </a>
                    </div>
                    {{ end }}
                </div>
            </div>
            {{ end }}
        </div>
    </div>
</div>

<style>
.sitemap-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem;
}

.sitemap-description {
    color: #666;
    margin-bottom: 1rem;
}

.sitemap-controls {
    margin-bottom: 2rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.sitemap-control-btn {
    background: #007acc;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}

.sitemap-control-btn:hover {
    background: #005a9e;
}

.sitemap-tree {
    font-family: 'Courier New', monospace;
    margin-bottom: 3rem;
}

.sitemap-item {
    margin: 0.5rem 0;
    padding: 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s;
    border: 1px solid transparent;
}

.sitemap-item:hover {
    background-color: #f5f5f5;
    border-color: #e0e0e0;
}

.sitemap-item a {
    text-decoration: none;
    color: #333;
    display: flex;
    align-items: center;
    flex: 1;
}

.sitemap-item a:hover {
    color: #007acc;
}

.sitemap-item-header {
    display: flex;
    align-items: center;
    width: 100%;
}

.sitemap-toggle {
    background: none;
    border: none;
    cursor: pointer;
    margin-right: 0.5rem;
    font-size: 0.8rem;
    color: #666;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sitemap-toggle:hover {
    color: #007acc;
}

.sitemap-children {
    margin-left: 2rem;
    border-left: 2px solid #e0e0e0;
    padding-left: 1rem;
    margin-top: 0.5rem;
}

.sitemap-children.collapsed {
    display: none;
}

.sitemap-icon {
    margin-right: 0.5rem;
    font-size: 0.9rem;
}

.sitemap-page-icon::before {
    content: "üìÑ";
}

.sitemap-folder-icon::before {
    content: "üìÅ";
}

.sitemap-post-icon::before {
    content: "üìù";
}

.sitemap-taxonomy-icon::before {
    content: "üè∑Ô∏è";
}

.sitemap-count {
    font-size: 0.8rem;
    color: #666;
    margin-left: 0.5rem;
    background: #e0e0e0;
    padding: 0.1rem 0.4rem;
    border-radius: 10px;
}

.sitemap-level-0 { margin-left: 0; }
.sitemap-level-1 { margin-left: 1rem; }
.sitemap-level-2 { margin-left: 2rem; }
.sitemap-level-3 { margin-left: 3rem; }
.sitemap-level-4 { margin-left: 4rem; }

.sitemap-taxonomy-section {
    border-top: 2px solid #e0e0e0;
    padding-top: 2rem;
}

.sitemap-taxonomy-section h2 {
    margin-bottom: 1rem;
}

.sitemap-taxonomies {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.sitemap-taxonomy-group h3 {
    margin-bottom: 0.5rem;
    color: #333;
}

.sitemap-taxonomy-terms {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.sitemap-taxonomy-term a {
    display: flex;
    align-items: center;
    text-decoration: none;
    color: #333;
    padding: 0.3rem 0.5rem;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.sitemap-taxonomy-term a:hover {
    background-color: #f5f5f5;
    color: #007acc;
}

@media (max-width: 768px) {
    .sitemap-container {
        padding: 1rem;
    }
    
    .sitemap-controls {
        flex-direction: column;
    }
    
    .sitemap-taxonomies {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggles = document.querySelectorAll('.sitemap-toggle');
    const expandAllBtn = document.getElementById('expand-all');
    const collapseAllBtn = document.getElementById('collapse-all');
    const toggleTaxonomiesBtn = document.getElementById('toggle-taxonomies');
    const taxonomySection = document.querySelector('.sitemap-taxonomy-section');
    
    // Toggle individual sections
    toggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            const children = this.closest('.sitemap-item').querySelector('.sitemap-children');
            if (children) {
                children.classList.toggle('collapsed');
                this.textContent = children.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
            }
        });
    });
    
    // Expand all
    expandAllBtn.addEventListener('click', function() {
        toggles.forEach(toggle => {
            const children = toggle.closest('.sitemap-item').querySelector('.sitemap-children');
            if (children && children.classList.contains('collapsed')) {
                children.classList.remove('collapsed');
                toggle.textContent = '‚ñº';
            }
        });
    });
    
    // Collapse all
    collapseAllBtn.addEventListener('click', function() {
        toggles.forEach(toggle => {
            const children = toggle.closest('.sitemap-item').querySelector('.sitemap-children');
            if (children && !children.classList.contains('collapsed')) {
                children.classList.add('collapsed');
                toggle.textContent = '‚ñ∂';
            }
        });
    });
    
    // Toggle taxonomies
    toggleTaxonomiesBtn.addEventListener('click', function() {
        taxonomySection.style.display = taxonomySection.style.display === 'none' ? 'block' : 'none';
    });
});
</script>
{{ end }}

{{ define "sitemap-enhanced-tree-item" }}
{{ $page := .page }}
{{ $level := .level }}
{{ $maxLevel := .maxLevel }}

{{ if and $page (le $level $maxLevel) }}
<div class="sitemap-item sitemap-level-{{ $level }}">
    <div class="sitemap-item-header">
        <a href="{{ $page.RelPermalink }}">
            {{ if eq $level 0 }}
                <span class="sitemap-icon sitemap-folder-icon"></span>
                üè† Home
            {{ else if $page.IsSection }}
                <span class="sitemap-icon sitemap-folder-icon"></span>
                {{ $page.Title | default $page.Name }}
            {{ else if eq $page.Type "posts" }}
                <span class="sitemap-icon sitemap-post-icon"></span>
                {{ $page.Title | default $page.Name }}
            {{ else }}
                <span class="sitemap-icon sitemap-page-icon"></span>
                {{ $page.Title | default $page.Name }}
            {{ end }}
        </a>
        
        {{ if and (lt $level $maxLevel) (or $page.Pages $page.Sections) }}
            {{ $hasChildren := or $page.Pages $page.Sections }}
            {{ if $hasChildren }}
                {{ $childCount := add (len $page.Pages) (len $page.Sections) }}
                <span class="sitemap-count">{{ $childCount }}</span>
                <button class="sitemap-toggle">‚ñº</button>
            {{ end }}
        {{ end }}
    </div>
    
    {{ if and (lt $level $maxLevel) (or $page.Pages $page.Sections) }}
        {{ $hasChildren := or $page.Pages $page.Sections }}
        {{ if $hasChildren }}
            <div class="sitemap-children">
                {{ range $page.Sections }}
                    {{ template "sitemap-enhanced-tree-item" (dict "page" . "level" (add $level 1) "maxLevel" $maxLevel) }}
                {{ end }}
                {{ range $page.Pages }}
                    {{ if not .IsSection }}
                        {{ template "sitemap-enhanced-tree-item" (dict "page" . "level" (add $level 1) "maxLevel" $maxLevel) }}
                    {{ end }}
                {{ end }}
            </div>
        {{ end }}
    {{ end }}
</div>
{{ end }}
{{ end }}
